<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Philippine Railway Company: Panay Line 1920 (Complete Edition)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Lato:wght@300;400;700&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Base Styles */
        body { font-family: 'Lato', sans-serif; background-color: #f4f1ea; color: #2d2a26; }
        h1, h2, h3, .serif-font { font-family: 'Playfair Display', serif; }
        .mono-font { font-family: 'Courier Prime', monospace; }
        
        /* Interactive Elements */
        .station-node-container:hover { background-color: rgba(194, 65, 12, 0.05); }
        .station-marker { transition: all 0.3s ease; }
        .active .station-marker {
            background-color: #c2410c; 
            transform: scale(1.25);
            box-shadow: 0 0 0 4px rgba(194, 65, 12, 0.2);
        }
        .active .station-text { color: #c2410c; font-weight: 700; }

        /* Graphics */
        .rail-line-vertical {
            background: repeating-linear-gradient(to bottom, #4a453e, #4a453e 8px, transparent 8px, transparent 16px);
            width: 4px;
        }
        .vintage-border {
            border: 1px solid #d1ccc0;
            box-shadow: 6px 6px 0px rgba(45, 42, 38, 0.1);
            background-color: #fffcf5;
        }

        /* Scrollbars */
        .vintage-scroll::-webkit-scrollbar { width: 8px; }
        .vintage-scroll::-webkit-scrollbar-track { background: #e5e0d6; }
        .vintage-scroll::-webkit-scrollbar-thumb { background: #a8a29e; border-radius: 4px; }

        /* Timetable Specifics */
        .timetable-row { border-bottom: 1px solid #e5e0d6; }
        .timetable-row:nth-child(even) { background-color: #f9f7f2; }
        .timetable-row:hover { background-color: #ffedd5; }
        
        /* Special Rows */
        .water-stop-row { background-color: #eff6ff !important; } /* Light blue for water */
        .crossing-highlight {
            background-color: #fff7ed !important;
            border-top: 2px dashed #c2410c;
            border-bottom: 2px dashed #c2410c;
        }
        
        /* Animation */
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Blueprint Grid Background */
        .blueprint-bg {
            background-color: #2e3642;
            background-image: linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px);
            background-size: 20px 20px;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Header -->
    <header class="bg-[#2d2a26] text-[#f4f1ea] py-6 border-b-4 border-[#c2410c] shadow-lg z-20 relative">
        <div class="container mx-auto px-4 text-center">
            <h1 class="text-3xl md:text-5xl font-bold tracking-widest uppercase mb-2">Philippine Railway Co.</h1>
            <p class="serif-font text-lg md:text-xl text-[#d1ccc0] italic">Panay Division ‚Ä¢ Infrastructure & Operations Audit (1920)</p>
        </div>
    </header>

    <!-- Controls -->
    <section class="bg-[#e5e0d6] py-6 shadow-inner relative z-10">
        <div class="container mx-auto px-4 text-center">
            <p class="text-gray-800 mb-4 max-w-4xl mx-auto text-sm md:text-base">
                Explore the <strong>33-station network</strong>. Updated with Annual Report data: 
                <span class="font-bold text-[#c2410c]">Sub-terminals</span> at Pototan, Passi, and Dumarao include Wyes, Ash Pits, and Water Tanks. 
                <span class="font-bold text-blue-800">Water Stops</span> and <span class="font-bold text-[#c2410c]">Passing Sidings</span> (every ~7 miles) are now integrated into the timetable.
            </p>
            <div class="inline-flex rounded-md shadow-sm" role="group">
                <button onclick="switchView('inspector')" id="btn-inspector" class="px-6 py-2 text-xs md:text-sm font-bold uppercase tracking-widest bg-[#2d2a26] text-white border border-[#2d2a26] rounded-l-lg hover:bg-[#444]">
                    Station Inspector
                </button>
                <button onclick="switchView('timetable')" id="btn-timetable" class="px-6 py-2 text-xs md:text-sm font-bold uppercase tracking-widest bg-[#e5e0d6] text-[#2d2a26] border border-[#a8a29e] rounded-r-lg hover:bg-[#d6d3d1]">
                    Master Timetable
                </button>
            </div>
        </div>
    </section>

    <!-- Main Workspace -->
    <main class="flex-grow container mx-auto px-4 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 h-[800px]">
            
            <!-- LEFT: Navigation List -->
            <div class="lg:col-span-4 h-full flex flex-col vintage-border overflow-hidden bg-white">
                <div class="bg-[#d6d3d1] p-3 border-b border-[#a8a29e] flex justify-between items-center">
                    <h3 class="font-bold text-[#2d2a26] uppercase text-xs tracking-wide">Route Manifest</h3>
                    <span class="text-[10px] font-bold text-gray-500">KM 0.0 ‚ûù KM 116.6</span>
                </div>
                <div class="overflow-y-auto vintage-scroll flex-grow relative p-4 bg-[#f4f1ea]">
                    <div class="absolute left-[29px] top-0 bottom-0 rail-line-vertical opacity-40"></div>
                    <div id="station-list" class="space-y-3 relative z-10"></div>
                </div>
            </div>

            <!-- RIGHT: Dynamic Panel -->
            <div class="lg:col-span-8 h-full relative vintage-border bg-white overflow-hidden flex flex-col">
                
                <!-- VIEW 1: INSPECTOR -->
                <div id="view-inspector" class="flex-1 flex flex-col fade-in overflow-y-auto">
                    <!-- Top Block: Identity -->
                    <div class="p-8 pb-4">
                        <div class="flex justify-between items-start mb-6 border-b-2 border-[#2d2a26] pb-4">
                            <div>
                                <span id="dt-type" class="inline-block px-3 py-1 bg-[#2d2a26] text-[#f4f1ea] text-xs font-bold uppercase tracking-widest mb-2">Terminal</span>
                                <h2 id="dt-name" class="text-4xl md:text-5xl font-bold text-[#2d2a26] serif-font">Iloilo City</h2>
                                <p id="dt-province" class="text-lg text-[#78716c] italic mt-1">Iloilo Province</p>
                            </div>
                            <div class="text-right">
                                <div class="text-5xl font-bold text-[#c2410c] serif-font" id="dt-km">0.0</div>
                                <div class="text-xs uppercase text-gray-500 font-bold tracking-widest">Kilometer</div>
                            </div>
                        </div>

                        <div class="bg-[#f9f7f2] p-6 border-l-4 border-[#c2410c] mb-6 shadow-sm">
                            <h4 class="text-xs font-bold uppercase text-[#57534e] mb-2 tracking-wide">Operational Notes</h4>
                            <p id="dt-desc" class="text-gray-800 text-lg leading-relaxed font-serif">
                                Description loading...
                            </p>
                        </div>
                    </div>

                    <!-- Middle Block: Blueprint Specs -->
                    <div class="blueprint-bg p-6 text-white flex-grow border-t-4 border-[#2d2a26]">
                        <h4 class="text-xs font-bold uppercase tracking-[0.2em] mb-4 text-gray-400 border-b border-gray-600 pb-2">Track & Facility Specifications</h4>
                        
                        <div class="grid grid-cols-2 gap-8">
                            <!-- Left: Capacity -->
                            <div>
                                <div class="mb-4">
                                    <span class="block text-[10px] uppercase text-gray-400">Siding Capacity</span>
                                    <span id="dt-siding" class="text-xl font-mono text-yellow-500">40 Cars</span>
                                </div>
                                <div>
                                    <span class="block text-[10px] uppercase text-gray-400">Class</span>
                                    <span id="dt-status" class="text-lg font-mono">Sub-Terminal</span>
                                </div>
                            </div>

                            <!-- Right: Facilities List -->
                            <div>
                                <span class="block text-[10px] uppercase text-gray-400 mb-2">Installed Assets</span>
                                <ul id="dt-facilities" class="space-y-2 text-sm font-mono">
                                    <!-- JS Injected -->
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VIEW 2: TIMETABLE -->
                <div id="view-timetable" class="hidden flex-1 flex-col bg-[#fffcf5] fade-in h-full">
                    <div class="bg-[#2d2a26] text-[#f4f1ea] p-4 flex justify-between items-center shadow-md shrink-0">
                        <div>
                            <h3 class="serif-font text-xl text-white">Working Timetable No. 4</h3>
                            <div class="text-[10px] uppercase tracking-widest text-[#c2410c] mt-1 font-bold">Includes Water Stops & Siding Dwell</div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs font-mono text-gray-300">NORTH: Read Down ‚Üì</div>
                            <div class="text-xs font-mono text-gray-300">SOUTH: Read Down ‚Üì</div>
                        </div>
                    </div>

                    <div class="flex-grow overflow-auto vintage-scroll relative h-full">
                        <table class="w-full text-left border-collapse min-w-[600px]">
                            <thead class="bg-[#e5e0d6] text-[#2d2a26] sticky top-0 z-20 shadow-sm">
                                <tr>
                                    <th class="p-3 border-b-2 border-[#a8a29e] w-1/3 text-xs uppercase font-bold tracking-wider">Station</th>
                                    <th class="p-2 border-b-2 border-[#a8a29e] text-center bg-[#d6d3d1] border-r border-gray-400 w-1/6">
                                        <div class="text-[10px] uppercase font-bold">Northbound</div>
                                        <div class="font-mono text-xs font-bold">TR #1</div>
                                    </th>
                                    <th class="p-2 border-b-2 border-[#a8a29e] text-center bg-[#d6d3d1] w-1/6">
                                        <div class="text-[10px] uppercase font-bold">Northbound</div>
                                        <div class="font-mono text-xs font-bold">TR #3</div>
                                    </th>
                                    <th class="p-2 border-b-2 border-[#a8a29e] text-center bg-[#e7e5e4] border-l-4 border-double border-gray-400 w-1/6">
                                        <div class="text-[10px] uppercase font-bold">Southbound</div>
                                        <div class="font-mono text-xs font-bold">TR #2</div>
                                    </th>
                                    <th class="p-2 border-b-2 border-[#a8a29e] text-center bg-[#e7e5e4] w-1/6">
                                        <div class="text-[10px] uppercase font-bold">Southbound</div>
                                        <div class="font-mono text-xs font-bold">TR #4</div>
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="timetable-body" class="mono-font text-sm text-[#2d2a26]"></tbody>
                        </table>
                    </div>
                    
                    <div class="p-3 bg-[#e5e0d6] border-t border-[#d1ccc0] text-[10px] text-gray-600 flex justify-between shrink-0 font-bold uppercase tracking-wide">
                        <span>Notes: 'f' = Flag Stop</span>
                        <span>üíß = Water Stop (7 min)</span>
                        <span>‚öî = Crossing (20 min)</span>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <!-- Analytics Section -->
    <section class="bg-[#e5e0d6] py-16 border-t border-[#d1ccc0]">
        <div class="container mx-auto px-4">
            <h2 class="text-3xl font-bold text-center text-[#2d2a26] serif-font mb-10">Engineering Analysis</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="vintage-border p-4 bg-white">
                    <h3 class="text-sm font-bold uppercase text-[#2d2a26] mb-4 border-l-4 border-[#c2410c] pl-3">Gradient Profile</h3>
                    <div class="chart-wrapper"><canvas id="elevationChart"></canvas></div>
                </div>
                <div class="vintage-border p-4 bg-white">
                    <h3 class="text-sm font-bold uppercase text-[#2d2a26] mb-4 border-l-4 border-[#c2410c] pl-3">Infrastructure Distribution</h3>
                    <div class="chart-wrapper"><canvas id="distributionChart"></canvas></div>
                </div>
            </div>
        </div>
    </section>

    <!-- Fare Calculator (RESTORED) -->
    <section class="bg-[#2d2a26] py-12 text-[#f4f1ea]">
        <div class="container mx-auto px-4 text-center max-w-2xl">
            <h2 class="text-2xl font-bold serif-font text-[#c2410c] mb-6">Ticket Office</h2>
            <div class="bg-[#3a3632] p-6 rounded shadow-lg border border-[#57534e]">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="text-left">
                        <label class="text-[10px] uppercase font-bold text-gray-400 tracking-wider">Origin</label>
                        <select id="calc-origin" class="w-full bg-[#2d2a26] text-white border border-gray-600 p-2 mt-1 rounded text-sm focus:border-[#c2410c] outline-none"></select>
                    </div>
                    <div class="text-left">
                        <label class="text-[10px] uppercase font-bold text-gray-400 tracking-wider">Destination</label>
                        <select id="calc-dest" class="w-full bg-[#2d2a26] text-white border border-gray-600 p-2 mt-1 rounded text-sm focus:border-[#c2410c] outline-none"></select>
                    </div>
                </div>
                <button id="calc-btn" class="w-full bg-[#c2410c] hover:bg-[#a1350a] text-white font-bold py-3 uppercase tracking-widest text-sm rounded shadow transition-all">
                    Purchase Ticket (3rd Class)
                </button>
                <div id="fare-output" class="mt-6 hidden pt-4 border-t border-dashed border-gray-600">
                    <div class="text-4xl font-bold serif-font text-[#facc15]"><span id="fare-val">0.00</span> PHP</div>
                    <div class="text-[10px] text-gray-400 mt-1 uppercase tracking-wide">Rate: 0.03 PHP/km ‚Ä¢ Valid for one passage</div>
                </div>
            </div>
        </div>
    </section>

    <footer class="bg-[#1c1917] text-[#57534e] py-8 text-center text-xs">
        <p>Digitally Reconstructed from PRC Annual Reports & Engineering Audits (1920)</p>
    </footer>

    <!-- LOGIC ENGINE -->
    <script>
        // --- ENHANCED STATION DATA ---
        // Siding Rules: ~7 miles (11km). 
        // Sub-terminals: Pototan, Passi, Dumarao (Wye, Ash Pit, Water, Storage).
        
        const stations = [
            { name: "Iloilo City", km: 0.0, type: "Terminal", status: "Permanent", elev: 3, facilities: ["Roundhouse", "Machine Shops", "Wharf Tracks", "Water Tank"], siding: "Terminal Yard", notes: "Main Southern Terminus." },
            { name: "La Paz", km: 2.6, type: "Station", status: "Permanent", elev: 4, facilities: ["General Offices", "Foundry", "Car Shops"], siding: "Yard", notes: "Operational HQ." },
            { name: "High School", km: 3.4, type: "Stop", status: "Flag Stop", elev: 4, facilities: [], siding: "None", notes: "Student Halt." },
            { name: "Jaro", km: 5.0, type: "Station", status: "Permanent", elev: 5, facilities: ["Loading Track"], siding: "10 Cars", notes: "Market hub." },
            { name: "Central Phil. Univ.", km: 6.2, type: "Stop", status: "Flag Stop", elev: 6, facilities: [], siding: "None", notes: "School halt." },
            { name: "Pavia", km: 11.1, type: "Station", status: "Permanent", elev: 8, facilities: ["Passing Siding"], siding: "40 Cars", notes: "Standard passing point (7 mi from HQ)." },
            { name: "Santa Barbara", km: 16.5, type: "Station", status: "Permanent", elev: 10, facilities: ["Water Tank", "Siding"], siding: "20 Cars", notes: "Historic town." },
            { name: "Cabilauan", km: 22.7, type: "Stop", status: "Flag Stop", elev: 12, facilities: [], siding: "None", notes: "Barrio halt." },
            { name: "New Lucena", km: 25.8, type: "Station", status: "Permanent", elev: 14, facilities: ["Passing Siding"], siding: "40 Cars", notes: "Standard passing point." },
            { name: "Camoncil", km: 28.1, type: "Stop", status: "Flag Stop", elev: 15, facilities: [], siding: "None", notes: "Rural halt." },
            { name: "Pototan", km: 34.1, type: "Sub-Terminal", status: "Permanent", elev: 16, facilities: ["Wye ‚Ü©Ô∏è", "Water Tank üíß", "Ash Pit", "Storage Tracks"], siding: "Yard (60 Cars)", notes: "MAJOR HUB: Sub-terminal operations." },
            { name: "Abangay", km: 37.7, type: "Stop", status: "Flag Stop", elev: 18, facilities: [], siding: "None", notes: "Rural halt." },
            { name: "Tabugon (Dingle)", km: 42.4, type: "Station", status: "Permanent", elev: 20, facilities: ["Loading Track"], siding: "10 Cars", notes: "Quarry access." },
            { name: "Due√±as", km: 47.6, type: "Station", status: "Permanent", elev: 25, facilities: ["Passing Siding"], siding: "40 Cars", notes: "Standard passing point." },
            { name: "Passi", km: 54.1, type: "Sub-Terminal", status: "Permanent", elev: 35, facilities: ["Concrete Engine House üè†", "Wye ‚Ü©Ô∏è", "Water Tank üíß", "Ash Pit"], siding: "Yard (80 Cars)", notes: "MAJOR HUB: Central Division Point." },
            { name: "Ventura", km: 57.4, type: "Station", status: "Permanent", elev: 45, facilities: [], siding: "10 Cars", notes: "Scenic stop." },
            { name: "Bagacay", km: 59.6, type: "Stop", status: "Flag Stop", elev: 55, facilities: [], siding: "None", notes: "Upland halt." },
            { name: "Bitaogan", km: 62.4, type: "Stop", status: "Flag Stop", elev: 70, facilities: [], siding: "None", notes: "Halt." },
            { name: "Santo Tomas", km: 64.7, type: "Stop", status: "Flag Stop", elev: 85, facilities: [], siding: "None", notes: "Halt." },
            { name: "Summit", km: 66.8, type: "Stop", status: "Flag Stop", elev: 95, facilities: ["Siding"], siding: "15 Cars", notes: "Peak elevation safety siding." },
            { name: "Dumarao", km: 72.2, type: "Sub-Terminal", status: "Permanent", elev: 85, facilities: ["Wye ‚Ü©Ô∏è", "Water Tank üíß", "Ash Pit"], siding: "Yard (50 Cars)", notes: "MAJOR HUB: Hill section base." },
            { name: "Alipasiauan", km: 76.7, type: "Stop", status: "Flag Stop", elev: 80, facilities: [], siding: "None", notes: "River halt." },
            { name: "Buntog", km: 79.1, type: "Station", status: "Permanent", elev: 75, facilities: ["Passing Siding"], siding: "40 Cars", notes: "Standard passing point." },
            { name: "San Juan", km: 80.1, type: "Stop", status: "Flag Stop", elev: 65, facilities: [], siding: "None", notes: "Halt." },
            { name: "Cuartero", km: 83.5, type: "Station", status: "Permanent", elev: 40, facilities: ["Loading Track"], siding: "10 Cars", notes: "Corn center." },
            { name: "Dao", km: 89.4, type: "Station", status: "Permanent", elev: 20, facilities: ["Passing Siding", "Intermodal Ramp"], siding: "40 Cars", notes: "Road junction hub." },
            { name: "Km 93", km: 93.0, type: "Stop", status: "Flag Stop", elev: 18, facilities: ["Spur"], siding: "Spur", notes: "Sugar loading." },
            { name: "Km 94", km: 94.0, type: "Stop", status: "Flag Stop", elev: 18, facilities: ["Spur"], siding: "Spur", notes: "Sugar loading." },
            { name: "Lacaron", km: 96.2, type: "Stop", status: "Flag Stop", elev: 15, facilities: [], siding: "None", notes: "Halt." },
            { name: "Calaan", km: 98.5, type: "Stop", status: "Flag Stop", elev: 12, facilities: [], siding: "None", notes: "Halt." },
            { name: "Panitan", km: 102.9, type: "Station", status: "Permanent", elev: 10, facilities: ["Passing Siding", "Water Tank"], siding: "40 Cars", notes: "Sugar center." },
            { name: "Loctugan", km: 109.3, type: "Station", status: "Permanent", elev: 6, facilities: [], siding: "10 Cars", notes: "Suburban." },
            { name: "Capiz (Roxas)", km: 116.6, type: "Terminal", status: "Permanent", elev: 4, facilities: ["Roundhouse", "Wharf Tracks", "Water Tank"], siding: "Terminal Yard", notes: "Northern Terminus." }
        ];

        // --- DOM REFERENCES ---
        const listContainer = document.getElementById('station-list');
        const inspectorView = document.getElementById('view-inspector');
        const timetableView = document.getElementById('view-timetable');
        const btnInspector = document.getElementById('btn-inspector');
        const btnTimetable = document.getElementById('btn-timetable');

        // --- STATE & VIEW LOGIC ---
        function switchView(mode) {
            if (mode === 'inspector') {
                inspectorView.classList.remove('hidden');
                inspectorView.classList.add('flex');
                timetableView.classList.add('hidden');
                timetableView.classList.remove('flex');
                updateButtons(btnInspector, btnTimetable);
            } else {
                inspectorView.classList.add('hidden');
                inspectorView.classList.remove('flex');
                timetableView.classList.remove('hidden');
                timetableView.classList.add('flex');
                updateButtons(btnTimetable, btnInspector);
            }
        }

        function updateButtons(active, inactive) {
            active.className = "px-6 py-2 text-xs md:text-sm font-bold uppercase tracking-widest bg-[#2d2a26] text-white border border-[#2d2a26] rounded-l-lg hover:bg-[#444] rounded-r-lg";
            inactive.className = "px-6 py-2 text-xs md:text-sm font-bold uppercase tracking-widest bg-[#e5e0d6] text-[#2d2a26] border border-[#a8a29e] rounded-l-lg hover:bg-[#d6d3d1] rounded-r-lg";
            if(active.id === 'btn-inspector') { active.classList.remove('rounded-r-lg'); inactive.classList.remove('rounded-l-lg'); }
            else { active.classList.remove('rounded-l-lg'); inactive.classList.remove('rounded-r-lg'); }
        }

        // --- RENDER FUNCTIONS ---
        function renderStationList() {
            listContainer.innerHTML = '';
            stations.forEach((s, idx) => {
                const div = document.createElement('div');
                let dotClass = s.type.includes('Terminal') ? 'bg-[#c2410c]' : (s.status === 'Flag Stop' ? 'bg-white border-2 border-[#57534e]' : 'bg-[#2d2a26]');
                
                div.className = `flex items-center gap-3 cursor-pointer p-2 rounded-md station-node-container group ${idx===0 ? 'active':''}`;
                div.id = `node-${idx}`;
                div.onclick = () => loadInspector(idx);

                div.innerHTML = `
                    <div class="relative z-10 w-3 h-3 rounded-full flex-shrink-0 station-marker ${dotClass}"></div>
                    <div class="flex justify-between w-full items-baseline">
                        <span class="text-sm station-text transition-colors group-hover:text-[#c2410c] ${s.status === 'Flag Stop' ? 'text-gray-500 italic' : 'text-[#2d2a26] font-bold'}">${s.name}</span>
                        <span class="text-[10px] font-mono text-gray-400">${s.km.toFixed(1)}</span>
                    </div>
                `;
                listContainer.appendChild(div);
            });
            loadInspector(0); // Init first
        }

        function loadInspector(idx) {
            document.querySelectorAll('.station-node-container').forEach(el => el.classList.remove('active'));
            document.getElementById(`node-${idx}`).classList.add('active');
            const s = stations[idx];
            
            document.getElementById('dt-name').innerText = s.name;
            document.getElementById('dt-km').innerText = s.km.toFixed(1);
            document.getElementById('dt-desc').innerText = s.notes;
            document.getElementById('dt-type').innerText = s.type;
            document.getElementById('dt-siding').innerText = s.siding;
            document.getElementById('dt-status').innerText = s.type; 

            const facList = document.getElementById('dt-facilities');
            facList.innerHTML = '';
            if(s.facilities.length > 0) {
                s.facilities.forEach(f => {
                    const li = document.createElement('li');
                    li.className = "flex items-center text-yellow-500";
                    li.innerHTML = `<span class="w-2 h-2 bg-yellow-500 rounded-full mr-2"></span>${f}`;
                    facList.appendChild(li);
                });
            } else {
                facList.innerHTML = '<li class="text-gray-500 italic">No major assets listed</li>';
            }
        }

        // --- TIMETABLE ENGINE ---
        function generateTimetable() {
            const tbody = document.getElementById('timetable-body');
            tbody.innerHTML = '';

            const START_NB = 7 * 60; 
            const START_SB = 7 * 60;
            const SPEED_FLAT = 2.45;
            const SPEED_GRADE = 2.8;
            const PASSI_KM = 54.1;
            const MEET_DEPARTURE = 585; 
            const WATER_DWELL = 7;
            const waterStops = ["Pototan", "Dumarao"];

            let nb_schedule = [];
            let sb_times_map = {};

            let t_nb = START_NB;
            for(let i=0; i<stations.length; i++) {
                const s = stations[i];
                if(i > 0) {
                    const dist = s.km - stations[i-1].km;
                    const speed = (s.km > 54 && s.km < 72) ? SPEED_GRADE : SPEED_FLAT;
                    t_nb += (dist * speed);
                }
                if(waterStops.includes(s.name)) t_nb += WATER_DWELL;
                if(s.name === "Passi") {
                    if(t_nb < MEET_DEPARTURE) t_nb = MEET_DEPARTURE; 
                }
                nb_schedule.push(t_nb);
            }

            let t_sb = START_SB;
            for(let i=stations.length-1; i>=0; i--) {
                const s = stations[i];
                if(i < stations.length-1) {
                    const dist = stations[i+1].km - s.km;
                    const speed = (s.km > 54 && s.km < 72) ? SPEED_GRADE : SPEED_FLAT;
                    t_sb += (dist * speed);
                }
                if(waterStops.includes(s.name)) t_sb += WATER_DWELL;
                if(s.name === "Passi") {
                    if(t_sb < MEET_DEPARTURE) t_sb = MEET_DEPARTURE;
                }
                sb_times_map[i] = t_sb;
            }

            stations.forEach((s, i) => {
                const tr = document.createElement('tr');
                const isWater = waterStops.includes(s.name);
                const isPassi = s.name === "Passi";
                
                if(isWater) tr.classList.add('water-stop-row');
                if(isPassi) tr.classList.add('crossing-highlight');

                const timeStr = (mins, isPm) => {
                    const adj = mins + (isPm ? 360 : 0);
                    const h = Math.floor(adj/60)%24;
                    const m = Math.floor(adj%60);
                    return `${h>12?h-12:(h===0?12:h)}:${m.toString().padStart(2,'0')}`;
                }

                const flag = s.status === 'Flag Stop' ? '<span class="text-gray-400 italic mr-1">f</span>' : '';
                const icon = isWater ? 'üíß ' : (isPassi ? '‚öî ' : '');

                tr.innerHTML = `
                    <td class="p-3 ${isPassi||isWater ? 'font-bold text-[#2d2a26]' : 'text-[#2d2a26]'} border-r border-gray-300">
                        ${s.name}
                    </td>
                    <td class="p-2 text-center bg-[#f9f7f2] border-r border-gray-300">${flag}${icon}${timeStr(nb_schedule[i], false)}</td>
                    <td class="p-2 text-center bg-[#f9f7f2] border-r border-gray-300">${flag}${icon}${timeStr(nb_schedule[i], true)}</td>
                    <td class="p-2 text-center bg-white border-r border-gray-300 border-l-4 border-double">${flag}${icon}${timeStr(sb_times_map[i], false)}</td>
                    <td class="p-2 text-center bg-white">${flag}${icon}${timeStr(sb_times_map[i], true)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- CHART INIT ---
        function initCharts() {
            new Chart(document.getElementById('elevationChart'), {
                type: 'line',
                data: {
                    labels: stations.map(s => s.km),
                    datasets: [{
                        label: 'Elevation (m)',
                        data: stations.map(s => s.elev),
                        borderColor: '#2d2a26',
                        backgroundColor: 'rgba(194, 65, 12, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: true } } }
            });

            const facCounts = { Water: 0, Siding: 0, Hub: 0 };
            stations.forEach(s => {
                if(s.facilities.some(f => f.includes('Water'))) facCounts.Water++;
                if(s.siding.includes('Cars') || s.siding === 'Yard') facCounts.Siding++;
                if(s.type === 'Sub-Terminal') facCounts.Hub++;
            });

            new Chart(document.getElementById('distributionChart'), {
                type: 'bar',
                data: {
                    labels: ['Passing Sidings', 'Water Stops', 'Sub-Terminals'],
                    datasets: [{
                        label: 'Assets',
                        data: [facCounts.Siding, facCounts.Water, facCounts.Hub],
                        backgroundColor: ['#2d2a26', '#3b82f6', '#c2410c']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }
        
        // --- CALCULATOR LOGIC (RESTORED) ---
        function initCalculator() {
            const origin = document.getElementById('calc-origin');
            const dest = document.getElementById('calc-dest');
            
            stations.forEach((s, i) => {
                origin.add(new Option(s.name, i));
                dest.add(new Option(s.name, i));
            });
            
            // Set defaults to ends of the line
            dest.value = stations.length - 1; 

            document.getElementById('calc-btn').addEventListener('click', () => {
                const i1 = parseInt(origin.value);
                const i2 = parseInt(dest.value);
                
                const s1 = stations[i1];
                const s2 = stations[i2];
                
                const dist = Math.abs(s1.km - s2.km);
                const fare = (dist * 0.03).toFixed(2);
                
                const resultBox = document.getElementById('fare-output');
                const fareVal = document.getElementById('fare-val');
                
                fareVal.innerText = fare;
                resultBox.classList.remove('hidden');
            });
        }

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            renderStationList();
            generateTimetable();
            initCharts();
            initCalculator();
        });
    </script>
</body>
</html>
